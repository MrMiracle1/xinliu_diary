// æ—¥è®°åŠŸèƒ½ç®¡ç†å™¨
class DiaryController {
    constructor() {
        this.currentDate = DateUtils.getToday();
        this.currentDiary = null;
        this.autoSaveTimer = null;
        this.autoSaveDelay = 1000; // 1ç§’åè‡ªåŠ¨ä¿å­˜
        this.heatmapVisible = false; // çƒ­åŠ›å›¾æ˜¾ç¤ºçŠ¶æ€
        
        // æ‹–æ‹½çŠ¶æ€ç®¡ç†
        this.dragState = {
            draggedElement: null,
            placeholder: null,
            dragType: null
        };
        
        this.initializeElements();
        this.bindEvents();
        this.loadDiary(this.currentDate);
        this.initializeHeatmap(); // åˆå§‹åŒ–çƒ­åŠ›å›¾
    }
    
    // åˆå§‹åŒ–DOMå…ƒç´ 
    initializeElements() {
        this.elements = {
            currentDate: document.getElementById('current-date'),
            prevDay: document.getElementById('prev-day'),
            nextDay: document.getElementById('next-day'),
            inheritYesterday: document.getElementById('inherit-yesterday'),
            majorEventsList: document.getElementById('major-events-list'),
            addMajorEvent: document.getElementById('add-major-event'),
            todoList: document.getElementById('todo-list'),
            addTodo: document.getElementById('add-todo'),
            completedList: document.getElementById('completed-list'),
            addCompleted: document.getElementById('add-completed'),
            reflectionText: document.getElementById('reflection-text'),
            exportDiary: document.getElementById('export-diary-range'),
            clearAll: document.getElementById('clear-diary-range')
        };
        
        // è®¾ç½®æ—¥æœŸè¾“å…¥æ¡†çš„æœ€å¤§å€¼ä¸ºä»Šå¤©
        const today = DateUtils.getToday();
        this.elements.currentDate.max = today;
    }
    
    // ç»‘å®šäº‹ä»¶
    bindEvents() {
        // æ—¥æœŸå¯¼èˆª
        this.elements.currentDate.addEventListener('change', (e) => {
            const selectedDate = e.target.value;
            if (selectedDate && ValidationUtils.isValidDate(selectedDate)) {
                // æ£€æŸ¥æ˜¯å¦ä¸ºæœªæ¥æ—¥æœŸ
                const today = DateUtils.getToday();
                if (selectedDate > today) {
                    MessageUtils.showError('ä¸èƒ½é€‰æ‹©æœªæ¥æ—¥æœŸï¼Œåªèƒ½æŸ¥çœ‹å½“å‰åŠè¿‡å»çš„æ—¥è®°');
                    this.elements.currentDate.value = this.currentDate; // é‡ç½®ä¸ºå½“å‰æ—¥æœŸ
                    return;
                }
                this.loadDiary(selectedDate);
            }
        });
        
        this.elements.prevDay.addEventListener('click', () => {
            const prevDate = DateUtils.addDays(this.currentDate, -1);
            this.loadDiary(prevDate);
        });
        
        this.elements.nextDay.addEventListener('click', () => {
            const nextDate = DateUtils.addDays(this.currentDate, 1);
            const today = DateUtils.getToday();
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºæœªæ¥æ—¥æœŸ
            if (nextDate > today) {
                MessageUtils.showInfo('å·²æ˜¯æœ€æ–°æ—¥æœŸï¼Œä¸èƒ½æŸ¥çœ‹æœªæ¥çš„æ—¥è®°');
                return;
            }
            
            this.loadDiary(nextDate);
        });
        
        // ç»§æ‰¿æ˜¨æ—¥å¤§äº‹
        this.elements.inheritYesterday.addEventListener('click', () => {
            this.inheritYesterdayEvents();
        });
        
        // æ·»åŠ æŒ‰é’®
        this.elements.addMajorEvent.addEventListener('click', () => {
            this.addMajorEvent();
        });
        
        this.elements.addTodo.addEventListener('click', () => {
            this.addTodo();
        });
        
        this.elements.addCompleted.addEventListener('click', () => {
            this.addCompleted();
        });
        
        // æ„Ÿæ‚Ÿæ–‡æœ¬åŒºåŸŸ
        this.elements.reflectionText.addEventListener('input', debounce(() => {
            this.scheduleAutoSave();
        }, 300));
        
        // å¯¼å‡ºå’Œæ¸…ç©º
        this.elements.exportDiary.addEventListener('click', () => {
            this.showExportModal();
        });
        
        this.elements.clearAll.addEventListener('click', () => {
            this.showClearModal();
        });
    }
    
    // åŠ è½½æŒ‡å®šæ—¥æœŸçš„æ—¥è®°
    loadDiary(date) {
        // éªŒè¯æ—¥æœŸæ ¼å¼
        if (!date || !ValidationUtils.isValidDate(date)) {
            console.error('Invalid date:', date);
            return;
        }
        
        // ä¿å­˜å½“å‰æ—¥è®°
        if (this.currentDiary && this.currentDate) {
            this.saveDiary();
        }
        
        this.currentDate = date;
        this.currentDiary = diaryManager.getDiary(date);
        
        // è‡ªåŠ¨åˆ›å»ºæ—¥å¸¸ä»»åŠ¡
        this.createDailyTodos();
        
        // æ›´æ–°UI
        this.elements.currentDate.value = date;
        this.renderDiary();
        
        // æ›´æ–°é¡µé¢æ ‡é¢˜
        document.title = `æ—¥å¸¸è®°å½• - ${DateUtils.getChineseDate(date)}`;
        
        // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
        this.updateNavigationButtons();
        
        console.log('Loaded diary for date:', date);
    }
    
    // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
    updateNavigationButtons() {
        const today = DateUtils.getToday();
        const isToday = this.currentDate === today;
        
        // å¦‚æœå½“å‰æ˜¯ä»Šå¤©ï¼Œç¦ç”¨ä¸‹ä¸€å¤©æŒ‰é’®
        this.elements.nextDay.disabled = isToday;
        if (isToday) {
            this.elements.nextDay.style.opacity = '0.5';
            this.elements.nextDay.style.cursor = 'not-allowed';
            this.elements.nextDay.title = 'ä¸èƒ½æŸ¥çœ‹æœªæ¥æ—¥è®°';
        } else {
            this.elements.nextDay.style.opacity = '1';
            this.elements.nextDay.style.cursor = 'pointer';
            this.elements.nextDay.title = 'ä¸‹ä¸€å¤©';
        }
    }
    
    // æ¸²æŸ“æ—¥è®°å†…å®¹
    renderDiary() {
        this.renderMajorEvents();
        this.renderTodos();
        this.renderCompleted();
        this.renderReflection();
    }
    
    // æ¸²æŸ“ä»Šæ—¥å¤§äº‹ï¼ˆå…¨å±€äº‹ä»¶ç³»ç»Ÿï¼‰
    renderMajorEvents() {
        DOMUtils.clearElement(this.elements.majorEventsList);
        
        // ä¸ºå®¹å™¨æ·»åŠ æ‹–æ‹½æ”¯æŒ
        this.addContainerDragSupport(this.elements.majorEventsList, 'majorEvent');
        
        // è·å–ä¸å½“å‰æ—¥æœŸå…³è”çš„å¤§äº‹ä»¶
        const associatedEvents = diaryManager.getDateAssociatedEvents(this.currentDate);
        
        if (associatedEvents.length === 0) {
            this.elements.majorEventsList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“‹</div>
                    <p>è¿˜æ²¡æœ‰å…³è”å¤§äº‹ä»¶</p>
                    <p class="empty-state-hint">ç‚¹å‡»â€œ+â€æŒ‰é’®æ·»åŠ å¤§äº‹ä»¶ï¼Œæˆ–ä½¿ç”¨â€œç»§æ‰¿æ˜¨æ—¥å¤§äº‹â€åŠŸèƒ½</p>
                </div>
            `;
            return;
        }
        
        associatedEvents.forEach(event => {
            const eventElement = this.createEventElement(event, 'majorEvent');
            this.elements.majorEventsList.appendChild(eventElement);
        });
    }
    
    // æ¸²æŸ“å¾…åŠäº‹é¡¹
    renderTodos() {
        DOMUtils.clearElement(this.elements.todoList);
        
        // ä¸ºå®¹å™¨æ·»åŠ æ‹–æ‹½æ”¯æŒ
        this.addContainerDragSupport(this.elements.todoList, 'todo');
        
        if (this.currentDiary.todos.length === 0) {
            this.elements.todoList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">âœ…</div>
                    <p>è¿˜æ²¡æœ‰å¾…åŠäº‹é¡¹</p>
                </div>
            `;
            return;
        }
        
        this.currentDiary.todos.forEach(todo => {
            const todoElement = this.createTodoElement(todo);
            this.elements.todoList.appendChild(todoElement);
        });
    }
    
    // æ¸²æŸ“å®Œæˆäº‹é¡¹
    renderCompleted() {
        DOMUtils.clearElement(this.elements.completedList);
        
        // ä¸ºå®¹å™¨æ·»åŠ æ‹–æ‹½æ”¯æŒ
        this.addContainerDragSupport(this.elements.completedList, 'completed');
        
        if (this.currentDiary.completed.length === 0) {
            this.elements.completedList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ‰</div>
                    <p>è¿˜æ²¡æœ‰å®Œæˆçš„äº‹é¡¹</p>
                </div>
            `;
            return;
        }
        
        this.currentDiary.completed.forEach(completed => {
            const completedElement = this.createCompletedElement(completed);
            this.elements.completedList.appendChild(completedElement);
        });
    }
    
    // æ¸²æŸ“æ„Ÿæ‚Ÿ
    renderReflection() {
        this.elements.reflectionText.value = this.currentDiary.reflection || '';
    }
    
    // åˆ›å»ºäº‹ä»¶å…ƒç´ 
    createEventElement(event, type) {
        const eventDiv = DOMUtils.createElement('div', 'list-item');
        
        // æ·»åŠ æ‹–æ‹½å±æ€§
        eventDiv.draggable = true;
        eventDiv.dataset.eventId = event.id;
        eventDiv.dataset.eventType = type;
        
        // æ£€æŸ¥æ–‡æœ¬æ˜¯å¦è¿‡é•¿ï¼ˆè¶…è¿‡50ä¸ªå­—ç¬¦ï¼‰
        const isLongText = event.text.length > 50;
        const needsExpansion = isLongText;
        
        eventDiv.innerHTML = `
            <div class="drag-handle">â‹®â‹®</div>
            <input type="text" value="${StringUtils.escapeHtml(event.text)}" 
                   placeholder="è¾“å…¥å¤§äº‹ä»¶..." 
                   data-id="${event.id}"
                   title="${needsExpansion ? StringUtils.escapeHtml(event.text) : ''}">
            ${needsExpansion ? '<button class="text-expand-btn" onclick="diaryController.toggleTextExpansion(this)">...</button>' : ''}
            <button class="item-btn" onclick="diaryController.showEventDetails('${event.id}')">è¯¦æƒ…</button>
            <button class="item-btn danger" onclick="diaryController.removeEvent('${event.id}', '${type}')">åˆ é™¤</button>
        `;
        
        // ç»‘å®šæ‹–æ‹½äº‹ä»¶
        this.bindDragEvents(eventDiv, type);
        
        // ç»‘å®šè¾“å…¥äº‹ä»¶
        const input = eventDiv.querySelector('input');
        input.addEventListener('input', debounce(() => {
            this.updateEventText(event.id, input.value, type);
            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°å±•å¼€æŒ‰é’®
            this.updateTextExpansionButton(eventDiv, input.value);
        }, 300));
        
        // æ·»åŠ æ‚¬åœæç¤ºåŠŸèƒ½
        if (needsExpansion) {
            this.addTextTooltip(input);
        }
        
        return eventDiv;
    }
    
    // åˆ›å»ºå¾…åŠäº‹é¡¹å…ƒç´ 
    createTodoElement(todo) {
        const todoDiv = DOMUtils.createElement('div', 'list-item');
        if (todo.completed) {
            todoDiv.classList.add('completed');
        }
        
        // æ·»åŠ æ‹–æ‹½å±æ€§
        todoDiv.draggable = true;
        todoDiv.dataset.todoId = todo.id;
        todoDiv.dataset.eventType = 'todo';
        
        // æ£€æŸ¥æ–‡æœ¬æ˜¯å¦è¿‡é•¿
        const isLongText = todo.text.length > 50;
        const needsExpansion = isLongText;
        
        todoDiv.innerHTML = `
            <div class="drag-handle">â‹®â‹®</div>
            <input type="checkbox" ${todo.completed ? 'checked' : ''} 
                   onchange="diaryController.toggleTodo('${todo.id}')">
            <input type="text" value="${StringUtils.escapeHtml(todo.text)}" 
                   placeholder="è¾“å…¥å¾…åŠäº‹é¡¹..." 
                   data-id="${todo.id}"
                   title="${needsExpansion ? StringUtils.escapeHtml(todo.text) : ''}">
            ${needsExpansion ? '<button class="text-expand-btn" onclick="diaryController.toggleTextExpansion(this)">...</button>' : ''}
            <label class="daily-checkbox" title="æ ‡è®°ä¸ºæ—¥å¸¸ä»»åŠ¡ï¼Œæ¯å¤©è‡ªåŠ¨åˆ›å»º">
                <input type="checkbox" ${todo.isDaily ? 'checked' : ''} 
                       onchange="diaryController.toggleTodoDaily('${todo.id}')">
                <span class="daily-label">æ—¥å¸¸</span>
            </label>
            <select onchange="diaryController.updateTodoRelation('${todo.id}', this.value)">
                <option value="">é€‰æ‹©å…³è”å¤§äº‹</option>
                ${this.getMajorEventsOptions(todo.relatedEventId)}
            </select>
            <button class="item-btn danger" onclick="diaryController.removeTodo('${todo.id}')">åˆ é™¤</button>
        `;
        
        // ç»‘å®šæ‹–æ‹½äº‹ä»¶
        this.bindDragEvents(todoDiv, 'todo');
        
        // ç»‘å®šè¾“å…¥äº‹ä»¶
        const input = todoDiv.querySelector('input[type="text"]');
        input.addEventListener('input', debounce(() => {
            this.updateTodoText(todo.id, input.value);
            this.updateTextExpansionButton(todoDiv, input.value);
        }, 300));
        
        // æ·»åŠ æ‚¬åœæç¤ºåŠŸèƒ½
        if (needsExpansion) {
            this.addTextTooltip(input);
        }
        
        return todoDiv;
    }
    
    // åˆ›å»ºå®Œæˆäº‹é¡¹å…ƒç´ 
    createCompletedElement(completed) {
        const completedDiv = DOMUtils.createElement('div', 'list-item completed');
        
        // æ·»åŠ æ‹–æ‹½å±æ€§
        completedDiv.draggable = true;
        completedDiv.dataset.completedId = completed.id;
        completedDiv.dataset.eventType = 'completed';
        
        // æ£€æŸ¥æ–‡æœ¬æ˜¯å¦è¿‡é•¿
        const isLongText = completed.text.length > 50;
        const needsExpansion = isLongText;
        
        completedDiv.innerHTML = `
            <div class="drag-handle">â‹®â‹®</div>
            <span class="completed-icon">âœ“</span>
            <input type="text" value="${StringUtils.escapeHtml(completed.text)}" 
                   placeholder="è¾“å…¥å®Œæˆäº‹é¡¹..." 
                   data-id="${completed.id}"
                   title="${needsExpansion ? StringUtils.escapeHtml(completed.text) : ''}">
            ${needsExpansion ? '<button class="text-expand-btn" onclick="diaryController.toggleTextExpansion(this)">...</button>' : ''}
            <select onchange="diaryController.updateCompletedRelation('${completed.id}', this.value)">
                <option value="">é€‰æ‹©å…³è”å¾…åŠ</option>
                ${this.getTodosOptions(completed.relatedTodoId)}
            </select>
            <button class="item-btn danger" onclick="diaryController.removeCompleted('${completed.id}')">åˆ é™¤</button>
        `;
        
        // ç»‘å®šæ‹–æ‹½äº‹ä»¶
        this.bindDragEvents(completedDiv, 'completed');
        
        // ç»‘å®šè¾“å…¥äº‹ä»¶
        const input = completedDiv.querySelector('input[type="text"]');
        input.addEventListener('input', debounce(() => {
            this.updateCompletedText(completed.id, input.value);
            this.updateTextExpansionButton(completedDiv, input.value);
        }, 300));
        
        // æ·»åŠ æ‚¬åœæç¤ºåŠŸèƒ½
        if (needsExpansion) {
            this.addTextTooltip(input);
        }
        
        return completedDiv;
    }
    
    // ç»‘å®šæ‹–æ‹½äº‹ä»¶
    bindDragEvents(element, type) {
        element.addEventListener('dragstart', (e) => {
            this.dragState.draggedElement = element;
            this.dragState.dragType = type;
            element.classList.add('dragging');
            
            // åˆ›å»ºå ä½ç¬¦
            this.dragState.placeholder = document.createElement('div');
            this.dragState.placeholder.className = 'drag-placeholder';
            this.dragState.placeholder.textContent = 'æ”¾ç½®åœ¨è¿™é‡Œ';
            
            // è®¾ç½®æ‹–æ‹½æ•°æ®
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', element.dataset.eventId || element.dataset.todoId || element.dataset.completedId);
            
            console.log('=== å¼€å§‹æ‹–æ‹½ ===');
            console.log('æ‹–æ‹½å…ƒç´ ç±»å‹ (ä¼ å…¥å‚æ•°):', type);
            console.log('æ‹–æ‹½å…ƒç´ ç±»å‹ (dataset.eventType):', element.dataset.eventType);
            console.log('æ‹–æ‹½å…ƒç´ ID:', element.dataset.eventId || element.dataset.todoId || element.dataset.completedId);
            console.log('æ‹–æ‹½å…ƒç´ å†…å®¹:', element.querySelector('input[type="text"]')?.value);
            console.log('æ‹–æ‹½è§¦å‘æº:', e.target);
            console.log('===============');
        });
        
        element.addEventListener('dragend', () => {
            element.classList.remove('dragging');
            if (this.dragState.placeholder && this.dragState.placeholder.parentNode) {
                this.dragState.placeholder.remove();
            }
            
            // æ¸…ç†æ‹–æ‹½çŠ¶æ€
            this.dragState.draggedElement = null;
            this.dragState.placeholder = null;
            this.dragState.dragType = null;
            
            console.log('ç»“æŸæ‹–æ‹½');
        });
        
        element.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            // ç¡®ä¿åªåœ¨åŒç±»å‹å…ƒç´ é—´æ‹–æ‹½ - é€šè¿‡ data-event-type å±æ€§æ£€æŸ¥
            const targetType = element.dataset.eventType;
            const draggedType = this.dragState.draggedElement ? this.dragState.draggedElement.dataset.eventType : null;
            
            if (this.dragState.draggedElement && this.dragState.draggedElement !== element && 
                draggedType === targetType && this.dragState.placeholder) {
                
                const container = element.parentNode;
                const mouseY = e.clientY;
                const elementRect = element.getBoundingClientRect();
                const elementMiddle = elementRect.top + elementRect.height / 2;
                
                // ç§»é™¤ä¹‹å‰çš„å ä½ç¬¦
                if (this.dragState.placeholder.parentNode) {
                    this.dragState.placeholder.remove();
                }
                
                if (mouseY < elementMiddle) {
                    // æ’å…¥åˆ°å…ƒç´ ä¸Šæ–¹
                    container.insertBefore(this.dragState.placeholder, element);
                } else {
                    // æ’å…¥åˆ°å…ƒç´ ä¸‹æ–¹
                    container.insertBefore(this.dragState.placeholder, element.nextSibling);
                }
                
                console.log('æ‹–æ‹½æ‚¬åœ:', mouseY < elementMiddle ? 'ä¸Šæ–¹' : 'ä¸‹æ–¹', 'ç±»å‹åŒ¹é…:', draggedType, '==', targetType);
            }
        });
        
        element.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('ğŸ“¦ Dropäº‹ä»¶è§¦å‘ - ç›®æ ‡å…ƒç´ :', element.querySelector('input[type="text"]')?.value?.substring(0, 15));
            
            const targetType = element.dataset.eventType;
            const draggedType = this.dragState.draggedElement ? this.dragState.draggedElement.dataset.eventType : null;
            
            console.log('ğŸ” ç±»å‹æ£€æŸ¥:', {
                draggedType: draggedType,
                targetType: targetType,
                åŒ¹é…: draggedType === targetType,
                æ‹–æ‹½å…ƒç´ : this.dragState.draggedElement ? 'å­˜åœ¨' : 'ç¼ºå¤±',
                å ä½ç¬¦: this.dragState.placeholder ? 'å­˜åœ¨' : 'ç¼ºå¤±'
            });
            
            if (this.dragState.draggedElement && this.dragState.draggedElement !== element && 
                this.dragState.placeholder && draggedType === targetType) {
                
                const container = this.dragState.placeholder.parentNode;
                
                if (container) {
                    console.log('âœ… æ‰§è¡Œæ‹–æ‹½æ”¾ç½®...');
                    
                    // åœ¨å ä½ç¬¦ä½ç½®æ’å…¥æ‹–æ‹½å…ƒç´ 
                    container.insertBefore(this.dragState.draggedElement, this.dragState.placeholder);
                    this.dragState.placeholder.remove();
                    
                    // æ›´æ–°æ•°æ®é¡ºåº
                    this.updateItemOrder(container, targetType);
                    
                    console.log('âœ… æ‹–æ‹½æ”¾ç½®å®Œæˆ');
                } else {
                    console.log('âŒ å ä½ç¬¦æ²¡æœ‰çˆ¶å®¹å™¨');
                }
            } else {
                console.log('âŒ Dropæ¡ä»¶ä¸æ»¡è¶³');
                if (!this.dragState.draggedElement) console.log('  - æ‹–æ‹½å…ƒç´ ä¸å­˜åœ¨');
                if (!this.dragState.placeholder) console.log('  - å ä½ç¬¦ä¸å­˜åœ¨');
                if (draggedType !== targetType) console.log('  - ç±»å‹ä¸åŒ¹é…');
                if (this.dragState.draggedElement === element) console.log('  - æ‹–æ‹½åˆ°è‡ªèº«');
            }
        });
    }
    
    // æ›´æ–°é¡¹ç›®é¡ºåº
    updateItemOrder(container, eventType) {
        const items = Array.from(container.querySelectorAll('.list-item:not(.drag-placeholder)'));
        
        console.log('æ›´æ–°é¡¹ç›®é¡ºåº:', eventType, 'é¡¹ç›®æ•°é‡:', items.length);
        
        if (eventType === 'majorEvent') {
            const newOrder = [];
            items.forEach(item => {
                const eventId = item.dataset.eventId;
                const event = this.currentDiary.majorEvents.find(e => e.id === eventId);
                if (event) {
                    newOrder.push(event);
                }
            });
            this.currentDiary.majorEvents = newOrder;
            console.log('æ›´æ–°åçš„å¤§äº‹é¡ºåº:', newOrder.map(e => e.text.substring(0, 10)));
        } else if (eventType === 'todo') {
            const newOrder = [];
            items.forEach(item => {
                const todoId = item.dataset.todoId;
                const todo = this.currentDiary.todos.find(t => t.id === todoId);
                if (todo) {
                    newOrder.push(todo);
                }
            });
            this.currentDiary.todos = newOrder;
            console.log('æ›´æ–°åçš„å¾…åŠé¡ºåº:', newOrder.map(t => t.text.substring(0, 10)));
        } else if (eventType === 'completed') {
            const newOrder = [];
            items.forEach(item => {
                const completedId = item.dataset.completedId;
                const completed = this.currentDiary.completed.find(c => c.id === completedId);
                if (completed) {
                    newOrder.push(completed);
                }
            });
            this.currentDiary.completed = newOrder;
            console.log('æ›´æ–°åçš„å®Œæˆé¡ºåº:', newOrder.map(c => c.text.substring(0, 10)));
        }
        
        // ä¿å­˜æ›´æ”¹
        this.scheduleAutoSave();
        
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        this.showDragSuccessIndicator();
        
        console.log('âœ… æ‹–æ‹½é¡ºåºæ›´æ–°å®Œæˆ');
    }
    
    // æ˜¾ç¤ºæ‹–æ‹½æˆåŠŸæŒ‡ç¤ºå™¨
    showDragSuccessIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'drag-success-indicator';
        indicator.innerHTML = '<span class="success-icon">âœ“</span> é¡ºåºå·²æ›´æ–°';
        
        document.body.appendChild(indicator);
        
        // æ˜¾ç¤ºåŠ¨ç”»
        setTimeout(() => {
            indicator.classList.add('show');
        }, 10);
        
        // 2ç§’åéšè—
        setTimeout(() => {
            indicator.classList.remove('show');
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.remove();
                }
            }, 300);
        }, 2000);
    }
    
    // ä¸ºå®¹å™¨æ·»åŠ æ‹–æ‹½æ”¯æŒ
    addContainerDragSupport(container, expectedType) {
        if (container.dataset.dragSupported) {
            return; // å·²ç»æ·»åŠ è¿‡æ”¯æŒ
        }
        
        container.dataset.dragSupported = 'true';
        container.dataset.containerType = expectedType; // ä¿å­˜å®¹å™¨ç±»å‹
        
        container.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            // å¦‚æœæ‹–æ‹½åˆ°å®¹å™¨çš„ç©ºç™½åŒºåŸŸ
            const draggedType = this.dragState.draggedElement ? this.dragState.draggedElement.dataset.eventType : null;
            
            if (this.dragState.draggedElement && draggedType === expectedType && 
                this.dragState.placeholder && e.target === container) {
                
                // ç§»é™¤ä¹‹å‰çš„å ä½ç¬¦
                if (this.dragState.placeholder.parentNode) {
                    this.dragState.placeholder.remove();
                }
                
                // å°†å ä½ç¬¦æ·»åŠ åˆ°å®¹å™¨æœ«å°¾
                container.appendChild(this.dragState.placeholder);
                
                console.log('æ‹–æ‹½åˆ°å®¹å™¨ç©ºç™½åŒºåŸŸ, ç±»å‹åŒ¹é…:', draggedType, '==', expectedType);
            }
        });
        
        container.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            const draggedType = this.dragState.draggedElement ? this.dragState.draggedElement.dataset.eventType : null;
            
            console.log('ğŸ“¦ å®¹å™¨Dropäº‹ä»¶è§¦å‘:', {
                ç›®æ ‡: e.target === container ? 'å®¹å™¨æœ¬èº«' : 'å­å…ƒç´ ',
                æ‹–æ‹½ç±»å‹: draggedType,
                æœŸæœ›ç±»å‹: expectedType,
                ç›®æ ‡å…ƒç´ : e.target.className || e.target.tagName
            });
            
            console.log('ğŸ” å®¹å™¨Dropæ¡ä»¶æ£€æŸ¥:', {
                'ç›®æ ‡æ˜¯å®¹å™¨': e.target === container,
                'æ‹–æ‹½å…ƒç´ å­˜åœ¨': !!this.dragState.draggedElement,
                'ç±»å‹åŒ¹é…': draggedType === expectedType,
                'å ä½ç¬¦å­˜åœ¨': !!this.dragState.placeholder,
                'å ä½ç¬¦çˆ¶å®¹å™¨å­˜åœ¨': !!(this.dragState.placeholder && this.dragState.placeholder.parentNode)
            });
            
            // æ”¾å®½æ¡ä»¶ï¼šä¸ä»…é™äºç›´æ¥æ‹–æ‹½åˆ°å®¹å™¨ï¼Œä¹Ÿæ”¯æŒæ‹–æ‹½åˆ°å®¹å™¨å†…çš„ç©ºç™½åŒºåŸŸ
            const isValidTarget = e.target === container || 
                                 (e.target.parentNode === container && !e.target.classList.contains('list-item'));
            
            if (isValidTarget && this.dragState.draggedElement && 
                draggedType === expectedType && this.dragState.placeholder) {
                
                const containerElement = this.dragState.placeholder.parentNode;
                
                if (containerElement) {
                    console.log('âœ… æ‰§è¡Œå®¹å™¨æ‹–æ‹½æ”¾ç½®...');
                    
                    // åœ¨å ä½ç¬¦ä½ç½®æ’å…¥æ‹–æ‹½å…ƒç´ 
                    containerElement.insertBefore(this.dragState.draggedElement, this.dragState.placeholder);
                    this.dragState.placeholder.remove();
                    
                    // æ›´æ–°æ•°æ®é¡ºåº
                    this.updateItemOrder(containerElement, draggedType);
                    
                    console.log('âœ… å®¹å™¨æ‹–æ‹½æ”¾ç½®å®Œæˆ');
                } else {
                    console.log('âŒ å®¹å™¨ä¸­çš„å ä½ç¬¦æ²¡æœ‰çˆ¶å®¹å™¨');
                }
            } else {
                console.log('âŒ å®¹å™¨Dropæ¡ä»¶ä¸æ»¡è¶³ï¼ŒåŸå› :');
                if (!isValidTarget) console.log('  - ç›®æ ‡ä¸æ˜¯æœ‰æ•ˆçš„å®¹å™¨åŒºåŸŸ');
                if (!this.dragState.draggedElement) console.log('  - æ‹–æ‹½å…ƒç´ ä¸å­˜åœ¨');
                if (draggedType !== expectedType) console.log('  - ç±»å‹ä¸åŒ¹é…:', draggedType, '!=', expectedType);
                if (!this.dragState.placeholder) console.log('  - å ä½ç¬¦ä¸å­˜åœ¨');
            }
        });
    }
    
    // è·å–å¤§äº‹ä»¶é€‰é¡¹ï¼ˆå…¨å±€äº‹ä»¶ç³»ç»Ÿï¼‰
    getMajorEventsOptions(selectedId = '') {
        // è·å–ä¸å½“å‰æ—¥æœŸå…³è”çš„å¤§äº‹ä»¶
        const associatedEvents = diaryManager.getDateAssociatedEvents(this.currentDate);
        return associatedEvents.map(event => 
            `<option value="${event.id}" ${event.id === selectedId ? 'selected' : ''}>
                ${StringUtils.truncate(event.text, 20)}
            </option>`
        ).join('');
    }
    
    // è·å–å¾…åŠäº‹é¡¹é€‰é¡¹
    getTodosOptions(selectedId = '') {
        return this.currentDiary.todos.map(todo => 
            `<option value="${todo.id}" ${todo.id === selectedId ? 'selected' : ''}>
                ${StringUtils.truncate(todo.text, 20)}
            </option>`
        ).join('');
    }
    
    // æ·»åŠ å¤§äº‹ä»¶ï¼ˆå…¨å±€äº‹ä»¶ç³»ç»Ÿï¼‰
    addMajorEvent(text = '') {
        if (!text.trim()) {
            // å¦‚æœæ²¡æœ‰æ–‡æœ¬ï¼Œå…ˆæ¸²æŸ“ä¸€ä¸ªç©ºçš„è¾“å…¥æ¡†è®©ç”¨æˆ·è¾“å…¥
            this.renderMajorEvents();
            setTimeout(() => {
                const inputs = this.elements.majorEventsList.querySelectorAll('input[type="text"]');
                const emptyInput = Array.from(inputs).find(input => !input.value.trim());
                if (emptyInput) {
                    emptyInput.focus();
                }
            }, 100);
            return;
        }
        
        // åˆ›å»ºå…¨å±€å¤§äº‹ä»¶
        const globalEvent = diaryManager.createGlobalEvent(text);
        
        // å…³è”åˆ°å½“å‰æ—¥æœŸ
        diaryManager.associateEventToDate(globalEvent.id, this.currentDate);
        
        // é‡æ–°æ¸²æŸ“åˆ—è¡¨
        this.renderMajorEvents();
        this.scheduleAutoSave();
        
        // èšç„¦åˆ°æ–°æ·»åŠ çš„è¾“å…¥æ¡†
        setTimeout(() => {
            const inputs = this.elements.majorEventsList.querySelectorAll('input[type="text"]');
            const targetInput = Array.from(inputs).find(input => 
                input.dataset.eventId === globalEvent.id
            );
            if (targetInput) {
                targetInput.focus();
                targetInput.select();
            }
        }, 100);
        
        return globalEvent;
    }
    
    // æ·»åŠ å¾…åŠäº‹é¡¹
    addTodo(text = '') {
        const todo = {
            id: StringUtils.generateId(),
            text: text,
            completed: false,
            isDaily: false, // é»˜è®¤ä¸æ˜¯æ—¥å¸¸ä»»åŠ¡
            relatedEventId: '',
            createdAt: new Date().toISOString()
        };
        
        this.currentDiary.todos.push(todo);
        this.renderTodos();
        this.scheduleAutoSave();
        
        // èšç„¦åˆ°æ–°æ·»åŠ çš„è¾“å…¥æ¡†
        setTimeout(() => {
            const inputs = this.elements.todoList.querySelectorAll('input[type="text"]');
            const lastInput = inputs[inputs.length - 1];
            if (lastInput) {
                lastInput.focus();
            }
        }, 100);
    }
    
    // æ·»åŠ å®Œæˆäº‹é¡¹
    addCompleted(text = '') {
        const completed = {
            id: StringUtils.generateId(),
            text: text,
            relatedTodoId: '',
            completedAt: new Date().toISOString()
        };
        
        this.currentDiary.completed.push(completed);
        this.renderCompleted();
        this.scheduleAutoSave();
        
        // èšç„¦åˆ°æ–°æ·»åŠ çš„è¾“å…¥æ¡†
        setTimeout(() => {
            const inputs = this.elements.completedList.querySelectorAll('input[type="text"]');
            const lastInput = inputs[inputs.length - 1];
            if (lastInput) {
                lastInput.focus();
            }
        }, 100);
    }
    
    // æ˜¾ç¤ºäº‹ä»¶è¯¦æƒ…ï¼ˆå…¨å±€äº‹ä»¶ç³»ç»Ÿï¼‰
    showEventDetails(eventId) {
        // ä»å…¨å±€äº‹ä»¶ä¸­è·å–äº‹ä»¶
        const allGlobalEvents = diaryManager.getAllGlobalEvents();
        const event = allGlobalEvents[eventId];
        
        if (!event) {
            MessageUtils.showError('æ‰¾ä¸åˆ°æŒ‡å®šçš„äº‹ä»¶');
            return;
        }
        
        // è·å–å…³è”çš„æ—¥æœŸ
        const associatedDates = diaryManager.getEventAssociatedDates(eventId);
        
        // è·å–å…³è”çš„äº‹ä»¶é¡¹
        const relatedItems = this.getRelatedItems(eventId);
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content event-details-modal">
                <div class="modal-header">
                    <h2>å¤§äº‹ä»¶è¯¦æƒ…</h2>
                    <button class="modal-close" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="event-detail-section">
                        <label>äº‹ä»¶å†…å®¹ï¼š</label>
                        <textarea id="event-detail-text" placeholder="è¾“å…¥äº‹ä»¶å†…å®¹...">${StringUtils.escapeHtml(event.text)}</textarea>
                    </div>
                    <div class="event-detail-section">
                        <label>åˆ›å»ºæ—¶é—´ï¼š</label>
                        <div class="detail-info">${DateUtils.getChineseDate(event.createdAt.split('T')[0])} ${event.createdAt.split('T')[1]?.split('.')[0] || ''}</div>
                    </div>
                    ${event.updatedAt !== event.createdAt ? `
                        <div class="event-detail-section">
                            <label>æ›´æ–°æ—¶é—´ï¼š</label>
                            <div class="detail-info">${DateUtils.getChineseDate(event.updatedAt.split('T')[0])} ${event.updatedAt.split('T')[1]?.split('.')[0] || ''}</div>
                        </div>
                    ` : ''}
                    <div class="event-detail-section">
                        <label>ç›¸å…³é“¾æ¥ï¼š</label>
                        <input type="url" id="event-detail-link" placeholder="è¾“å…¥ç›¸å…³é“¾æ¥ (http://... æˆ– https://...)" value="${event.link || ''}">
                        <button class="link-test-btn" onclick="diaryController.openEventLink()" style="margin-top: 8px;">è·³è½¬é“¾æ¥</button>
                    </div>
                    <div class="event-detail-section">
                        <label>å…³è”æ—¥æœŸï¼ˆ${associatedDates.length} å¤©ï¼‰ï¼š</label>
                        <div class="associated-dates">
                            ${associatedDates.length > 0 ? `
                                <div class="dates-list">
                                    ${associatedDates.map(date => `
                                        <div class="date-item ${date === this.currentDate ? 'current' : ''}">
                                            <span class="date-label">${DateUtils.getChineseDate(date)}</span>
                                            <span class="date-weekday">${DateUtils.getWeekday(date)}</span>
                                            ${date !== this.currentDate ? `
                                                <button class="date-jump-btn" onclick="diaryController.jumpToDate('${date}')" title="è·³è½¬åˆ°æ­¤æ—¥æœŸ">æŸ¥çœ‹</button>
                                            ` : '<span class="current-indicator">å½“å‰</span>'}
                                            <button class="date-unlink-btn" onclick="diaryController.unlinkEventFromDate('${eventId}', '${date}')" title="å–æ¶ˆä¸æ­¤æ—¥æœŸçš„å…³è”">å–æ¶ˆå…³è”</button>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<div class="no-dates">æš‚æ— å…³è”æ—¥æœŸ</div>'}
                        </div>
                    </div>
                    ${relatedItems.todos.length > 0 || relatedItems.completed.length > 0 ? `
                        <div class="event-detail-section">
                            <label>å…³è”äº‹ä»¶ï¼š</label>
                            <div class="related-items">
                                ${relatedItems.todos.length > 0 ? `
                                    <div class="related-category">
                                        <h4>å¾…åŠäº‹é¡¹</h4>
                                        <div class="related-list">
                                            ${relatedItems.todos.map(todo => `
                                                <div class="related-item ${todo.completed ? 'completed' : 'pending'}">
                                                    <span class="status-icon">${todo.completed ? 'âœ“' : 'â—‹'}</span>
                                                    <span class="item-text">${StringUtils.escapeHtml(todo.text)}</span>
                                                    <span class="item-date">${DateUtils.getChineseDate(todo.date)}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                ${relatedItems.completed.length > 0 ? `
                                    <div class="related-category">
                                        <h4>å·²å®Œæˆäº‹é¡¹</h4>
                                        <div class="related-list">
                                            ${relatedItems.completed.map(item => `
                                                <div class="related-item completed">
                                                    <span class="status-icon">âœ“</span>
                                                    <span class="item-text">${StringUtils.escapeHtml(item.text)}</span>
                                                    <span class="item-date">${DateUtils.getChineseDate(item.date)}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                </div>
                <div class="modal-footer">
                    <button class="action-btn" onclick="diaryController.saveEventDetails('${eventId}')">ä¿å­˜</button>
                    <button class="action-btn" onclick="this.parentElement.parentElement.parentElement.remove()">å–æ¶ˆ</button>
                </div>
            </div>
        `;
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
        
        document.body.appendChild(modal);
        
        // è‡ªåŠ¨èšç„¦åˆ°æ–‡æœ¬æ¡†
        setTimeout(() => {
            document.getElementById('event-detail-text').focus();
        }, 100);
    }

    }
    
    // è·å–ä¸äº‹ä»¶å…³è”çš„äº‹ä»¶é¡¹
    getRelatedItems(eventId) {
        const allDiaries = diaryManager.getAllDiaries();
        const relatedTodos = [];
        const relatedCompleted = [];
        
        // éå†æ‰€æœ‰æ—¥è®°æŸ¥æ‰¾å…³è”é¡¹
        Object.entries(allDiaries).forEach(([date, diary]) => {
            // æŸ¥æ‰¾å…³è”çš„å¾…åŠäº‹é¡¹
            diary.todos.forEach(todo => {
                if (todo.relatedEventId === eventId) {
                    relatedTodos.push({
                        ...todo,
                        date: date
                    });
                }
            });
            
            // æŸ¥æ‰¾å…³è”çš„å®Œæˆäº‹é¡¹ï¼ˆé€šè¿‡å¾…åŠäº‹é¡¹é—´æ¥å…³è”ï¼‰
            diary.completed.forEach(completed => {
                // æŸ¥æ‰¾è¯¥å®Œæˆäº‹é¡¹å…³è”çš„å¾…åŠäº‹é¡¹
                const relatedTodo = diary.todos.find(t => t.id === completed.relatedTodoId);
                if (relatedTodo && relatedTodo.relatedEventId === eventId) {
                    relatedCompleted.push({
                        ...completed,
                        date: date
                    });
                }
            });
        });
        
        return {
            todos: relatedTodos.sort((a, b) => b.date.localeCompare(a.date)), // æŒ‰æ—¥æœŸé™åº
            completed: relatedCompleted.sort((a, b) => b.date.localeCompare(a.date))
        };
    }
    
    // è·³è½¬äº‹ä»¶é“¾æ¥
    openEventLink() {
        const linkInput = document.getElementById('event-detail-link');
        const link = linkInput.value.trim();
        
        if (!link) {
            MessageUtils.showInfo('è¯·å…ˆè¾“å…¥é“¾æ¥');
            return;
        }
        
        if (!link.startsWith('http://') && !link.startsWith('https://')) {
            MessageUtils.showError('é“¾æ¥å¿…é¡»ä»¥ http:// æˆ– https:// å¼€å¤´');
            return;
        }
        
        try {
            window.open(link, '_blank', 'noopener,noreferrer');
            MessageUtils.showSuccess('é“¾æ¥è·³è½¬æˆåŠŸ');
        } catch (error) {
            MessageUtils.showError('é“¾æ¥æ‰“å¼€å¤±è´¥ï¼š' + error.message);
        }
    }
    
    // ä¿å­˜äº‹ä»¶è¯¦æƒ…ï¼ˆå…¨å±€äº‹ä»¶ç³»ç»Ÿï¼‰
    saveEventDetails(eventId) {
        const allGlobalEvents = diaryManager.getAllGlobalEvents();
        const event = allGlobalEvents[eventId];
        
        if (!event) {
            MessageUtils.showError('æ‰¾ä¸åˆ°æŒ‡å®šçš„äº‹ä»¶');
            return;
        }
        
        const text = document.getElementById('event-detail-text').value.trim();
        const link = document.getElementById('event-detail-link').value.trim();
        
        if (!text) {
            MessageUtils.showError('äº‹ä»¶å†…å®¹ä¸èƒ½ä¸ºç©º');
            return;
        }
        
        // éªŒè¯é“¾æ¥æ ¼å¼
        if (link && !link.startsWith('http://') && !link.startsWith('https://')) {
            MessageUtils.showError('é“¾æ¥å¿…é¡»ä»¥ http:// æˆ– https:// å¼€å¤´');
            return;
        }
        
        // æ›´æ–°å…¨å±€äº‹ä»¶æ•°æ®
        const success = diaryManager.updateGlobalEvent(eventId, text, link);
        
        if (success) {
            // é‡æ–°æ¸²æŸ“åˆ—è¡¨
            this.renderMajorEvents();
            this.scheduleAutoSave();
            
            // å…³é—­æ¨¡æ€æ¡†
            document.querySelector('.modal-overlay').remove();
            
            MessageUtils.showSuccess('äº‹ä»¶è¯¦æƒ…ä¿å­˜æˆåŠŸ');
        } else {
            MessageUtils.showError('ä¿å­˜å¤±è´¥');
        }
    }
    
    // è·³è½¬åˆ°æŒ‡å®šæ—¥æœŸ
    jumpToDate(date) {
        // å…³é—­å½“å‰æ¨¡æ€æ¡†
        const modal = document.querySelector('.modal-overlay');
        if (modal) {
            modal.remove();
        }
        
        // åŠ è½½æŒ‡å®šæ—¥æœŸçš„æ—¥è®°
        this.loadDiary(date);
        MessageUtils.showSuccess(`å·²è·³è½¬åˆ° ${DateUtils.getChineseDate(date)}`);
    }
    
    // å–æ¶ˆäº‹ä»¶ä¸æ—¥æœŸçš„å…³è”
    unlinkEventFromDate(eventId, date) {
        ConfirmUtils.confirm(
            'å–æ¶ˆå…³è”',
            `ç¡®å®šè¦å–æ¶ˆè¯¥äº‹ä»¶ä¸ ${DateUtils.getChineseDate(date)} çš„å…³è”å—ï¼Ÿ`,
            () => {
                const success = diaryManager.dissociateEventFromDate(eventId, date);
                if (success) {
                    // å¦‚æœå–æ¶ˆçš„æ˜¯å½“å‰æ—¥æœŸï¼Œé‡æ–°æ¸²æŸ“åˆ—è¡¨
                    if (date === this.currentDate) {
                        this.renderMajorEvents();
                        this.scheduleAutoSave();
                    }
                    
                    // æ›´æ–°æ¨¡æ€æ¡†ä¸­çš„æ˜¾ç¤º
                    const modal = document.querySelector('.modal-overlay');
                    if (modal) {
                        modal.remove();
                        // é‡æ–°æ˜¾ç¤ºè¯¦æƒ…
                        this.showEventDetails(eventId);
                    }
                    
                    MessageUtils.showSuccess('å·²å–æ¶ˆå…³è”');
                } else {
                    MessageUtils.showError('å–æ¶ˆå…³è”å¤±è´¥');
                }
            }
        );
    }

    // ç®¡ç†å¤§äº‹ä»¶å…³è”ï¼ˆåŸç»§æ‰¿åŠŸèƒ½ï¼‰
    inheritYesterdayEvents() {
        const yesterday = DateUtils.addDays(this.currentDate, -1);
        const inheritableEvents = diaryManager.getInheritableEvents(this.currentDate);
        
        if (inheritableEvents.length === 0) {
            MessageUtils.showInfo('æ˜¨å¤©æ²¡æœ‰å¯å…³è”çš„å¤§äº‹ä»¶');
            return;
        }
        
        this.showEventAssociationModal(inheritableEvents, yesterday);
    }
    
    // æ˜¾ç¤ºå¤§äº‹ä»¶å…³è”ç®¡ç†æ¨¡æ€æ¡†
    showEventAssociationModal(events, yesterday) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content event-association-modal">
                <div class="modal-header">
                    <h2>å¤§äº‹ä»¶å…³è”ç®¡ç†</h2>
                    <button class="modal-close" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="association-info">
                        <p>é€‰æ‹©è¦ä¸ä»Šæ—¥å…³è”çš„å¤§äº‹ä»¶ï¼ˆ${DateUtils.getChineseDate(yesterday)} â†’ ${DateUtils.getChineseDate(this.currentDate)}ï¼‰</p>
                        <p class="association-hint">è¯´æ˜ï¼šåœ¨è¿™é‡Œé€‰æ‹©å…³è”åï¼Œè¯¥å¤§äº‹ä»¶å°†æ˜¾ç¤ºåœ¨ä»Šæ—¥çš„å¤§äº‹åˆ—è¡¨ä¸­ã€‚å–æ¶ˆå…³è”ä¸ä¼šåˆ é™¤äº‹ä»¶æœ¬èº«ã€‚</p>
                    </div>
                    <div class="association-list">
                        ${events.map(event => `
                            <div class="association-item">
                                <label class="association-checkbox">
                                    <input type="checkbox" value="${event.id}" checked>
                                    <span class="checkmark"></span>
                                    <div class="event-preview">
                                        <div class="event-text">${StringUtils.escapeHtml(event.text)}</div>
                                        <div class="event-meta">
                                            åˆ›å»ºäº ${DateUtils.getChineseDate(event.createdAt.split('T')[0])}
                                            Â Â |Â Â å…³è”æ—¥æœŸ: ${diaryManager.getEventAssociatedDates(event.id).length} å¤©
                                        </div>
                                    </div>
                                </label>
                            </div>
                        `).join('')}
                    </div>
                    <div class="association-actions">
                        <button class="association-select-all" onclick="diaryController.toggleSelectAllEvents(true)">å…¨é€‰</button>
                        <button class="association-select-none" onclick="diaryController.toggleSelectAllEvents(false)">å–æ¶ˆå…¨é€‰</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="action-btn" onclick="diaryController.confirmEventAssociation()">å…³è”é€‰ä¸­é¡¹</button>
                    <button class="action-btn" onclick="this.parentElement.parentElement.parentElement.remove()">å–æ¶ˆ</button>
                </div>
            </div>
        `;
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
        
        document.body.appendChild(modal);
        
        // ä¿å­˜åŸå§‹äº‹ä»¶æ•°æ®
        this.associationData = { events, yesterday };
    }
    
    // åˆ‡æ¢å…¨é€‰/å–æ¶ˆå…¨é€‰
    toggleSelectAllEvents(selectAll) {
        // å…¼å®¹æ—§çš„ç»§æ‰¿é€‰æ‹©å’Œæ–°çš„å…³è”é€‰æ‹©
        const inheritanceCheckboxes = document.querySelectorAll('.inheritance-item input[type="checkbox"]');
        const associationCheckboxes = document.querySelectorAll('.association-item input[type="checkbox"]');
        
        const allCheckboxes = [...inheritanceCheckboxes, ...associationCheckboxes];
        allCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAll;
        });
    }
    
    // ç¡®è®¤å…³è”é€‰ä¸­çš„äº‹ä»¶
    confirmEventAssociation() {
        const checkboxes = document.querySelectorAll('.association-item input[type="checkbox"]:checked');
        const selectedIds = Array.from(checkboxes).map(cb => cb.value);
        
        if (selectedIds.length === 0) {
            MessageUtils.showInfo('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªäº‹ä»¶è¿›è¡Œå…³è”');
            return;
        }
        
        let successCount = 0;
        
        // ä¸ºé€‰ä¸­çš„äº‹ä»¶å»ºç«‹å…³è”
        selectedIds.forEach(eventId => {
            const success = diaryManager.associateEventToDate(eventId, this.currentDate);
            if (success) {
                successCount++;
            }
        });
        
        if (successCount > 0) {
            // é‡æ–°æ¸²æŸ“å¤§äº‹ä»¶åˆ—è¡¨
            this.renderMajorEvents();
            this.scheduleAutoSave();
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        document.querySelector('.modal-overlay').remove();
        
        MessageUtils.showSuccess(`å·²å…³è” ${successCount} ä¸ªå¤§äº‹ä»¶`);
    }
    
    // æ›´æ–°å¾…åŠæ–‡æœ¬
    updateTodoText(id, text) {
        const todo = this.currentDiary.todos.find(t => t.id === id);
        if (todo) {
            todo.text = text;
            this.scheduleAutoSave();
        }
    }
    
    // æ›´æ–°å¤§äº‹ä»¶æ–‡æœ¬ï¼ˆå…¨å±€äº‹ä»¶ç³»ç»Ÿï¼‰
    updateEventText(id, text, type) {
        if (type === 'majorEvent') {
            // æ›´æ–°å…¨å±€å¤§äº‹ä»¶çš„æ–‡æœ¬
            const success = diaryManager.updateGlobalEvent(id, text);
            if (success) {
                this.scheduleAutoSave();
            }
        }
    }
    
    // æ›´æ–°å®Œæˆäº‹é¡¹æ–‡æœ¬
    updateCompletedText(id, text) {
        const completed = this.currentDiary.completed.find(c => c.id === id);
        if (completed) {
            completed.text = text;
            this.scheduleAutoSave();
        }
    }
    
    // åˆ‡æ¢å¾…åŠå®ŒæˆçŠ¶æ€
    toggleTodo(id) {
        const todo = this.currentDiary.todos.find(t => t.id === id);
        if (todo) {
            const wasCompleted = todo.completed;
            todo.completed = !todo.completed;
            
            // å¦‚æœä»æœªå®Œæˆå˜ä¸ºå·²å®Œæˆï¼Œè‡ªåŠ¨åˆ›å»ºå®Œæˆäº‹é¡¹
            if (!wasCompleted && todo.completed) {
                this.createCompletedFromTodo(todo);
            }
            // å¦‚æœä»å·²å®Œæˆå˜ä¸ºæœªå®Œæˆï¼Œåˆ é™¤å¯¹åº”çš„å®Œæˆäº‹é¡¹
            else if (wasCompleted && !todo.completed) {
                this.removeRelatedCompleted(todo.id);
            }
            
            this.renderTodos();
            this.renderCompleted();
            this.scheduleAutoSave();
        }
    }
    
    // åˆ‡æ¢å¾…åŠäº‹é¡¹æ—¥å¸¸æ ‡ç­¾
    toggleTodoDaily(id) {
        const todo = this.currentDiary.todos.find(t => t.id === id);
        if (todo) {
            todo.isDaily = !todo.isDaily;
            
            if (todo.isDaily) {
                MessageUtils.showSuccess('å·²æ ‡è®°ä¸ºæ—¥å¸¸ä»»åŠ¡ï¼Œå°†æ¯å¤©è‡ªåŠ¨åˆ›å»º');
                // ä¸ºæœªæ¥æ—¥æœŸè‡ªåŠ¨åˆ›å»ºæ—¥å¸¸ä»»åŠ¡
                this.createDailyTodosForFuture(todo);
            } else {
                MessageUtils.showInfo('å·²å–æ¶ˆæ—¥å¸¸æ ‡è®°');
            }
            
            this.scheduleAutoSave();
        }
    }
    
    // ä¸ºæœªæ¥æ—¥æœŸåˆ›å»ºæ—¥å¸¸ä»»åŠ¡ï¼ˆå¦‚æœå·²æœ‰æ—¥è®°ï¼‰
    createDailyTodosForFuture(dailyTodo) {
        const today = DateUtils.getToday();
        const allDiaries = diaryManager.getAllDiaries();
        
        // éå†å·²æœ‰çš„æ—¥è®°ï¼Œä¸ºæ¯ä¸ªæ—¥æœŸåˆ›å»ºæ—¥å¸¸ä»»åŠ¡
        Object.keys(allDiaries).forEach(date => {
            if (date !== this.currentDate) {
                const diary = allDiaries[date];
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ç›¸åŒçš„æ—¥å¸¸ä»»åŠ¡
                const existingDailyTodo = diary.todos.find(todo => 
                    todo.isDaily && todo.text === dailyTodo.text
                );
                
                if (!existingDailyTodo) {
                    // åˆ›å»ºæ—¥å¸¸ä»»åŠ¡å‰¯æœ¬
                    const newDailyTodo = {
                        id: StringUtils.generateId(),
                        text: dailyTodo.text,
                        completed: false,
                        isDaily: true,
                        relatedEventId: dailyTodo.relatedEventId || '',
                        createdAt: new Date().toISOString()
                    };
                    
                    diary.todos.push(newDailyTodo);
                }
            }
        });
        
        // ä¿å­˜æ•°æ®
        diaryManager.saveDiary(this.currentDate, this.currentDiary);
        Object.keys(allDiaries).forEach(date => {
            if (date !== this.currentDate) {
                diaryManager.saveDiary(date, allDiaries[date]);
            }
        });
    }
    
    // ä¸ºå½“å‰æ—¥æœŸåˆ›å»ºæ—¥å¸¸ä»»åŠ¡
    createDailyTodos() {
        const allDiaries = diaryManager.getAllDiaries();
        let hasNewDailyTodos = false;
        
        // éå†æ‰€æœ‰æ—¥è®°ï¼ŒæŸ¥æ‰¾æ‰€æœ‰æ ‡è®°ä¸ºæ—¥å¸¸çš„ä»»åŠ¡
        Object.entries(allDiaries).forEach(([date, diary]) => {
            diary.todos.forEach(todo => {
                if (todo.isDaily) {
                    // æ£€æŸ¥å½“å‰æ—¥æœŸæ˜¯å¦å·²ç»æœ‰ç›¸åŒçš„æ—¥å¸¸ä»»åŠ¡
                    const existingDailyTodo = this.currentDiary.todos.find(currentTodo => 
                        currentTodo.isDaily && currentTodo.text === todo.text
                    );
                    
                    if (!existingDailyTodo) {
                        // åˆ›å»ºæ—¥å¸¸ä»»åŠ¡å‰¯æœ¬
                        const newDailyTodo = {
                            id: StringUtils.generateId(),
                            text: todo.text,
                            completed: false,
                            isDaily: true,
                            relatedEventId: todo.relatedEventId || '',
                            createdAt: new Date().toISOString()
                        };
                        
                        this.currentDiary.todos.push(newDailyTodo);
                        hasNewDailyTodos = true;
                    }
                }
            });
        });
        
        // å¦‚æœæœ‰æ–°çš„æ—¥å¸¸ä»»åŠ¡ï¼Œä¿å­˜æ•°æ®
        if (hasNewDailyTodos) {
            diaryManager.saveDiary(this.currentDate, this.currentDiary);
        }
    }
    
    // ä»å¾…åŠäº‹é¡¹åˆ›å»ºå…³è”çš„å®Œæˆäº‹é¡¹
    createCompletedFromTodo(todo) {
        const completed = {
            id: StringUtils.generateId(),
            text: todo.text, // ç›´æ¥ä½¿ç”¨å¾…åŠäº‹é¡¹çš„æ–‡æœ¬
            relatedTodoId: todo.id,
            completedAt: new Date().toISOString()
        };
        
        this.currentDiary.completed.push(completed);
        
        // å»¶è¿Ÿèšç„¦åˆ°æ–°åˆ›å»ºçš„å®Œæˆäº‹é¡¹
        setTimeout(() => {
            const completedInputs = this.elements.completedList.querySelectorAll('input[type="text"]');
            const newInput = Array.from(completedInputs).find(input => input.dataset.id === completed.id);
            if (newInput) {
                newInput.focus();
                newInput.select(); // é€‰ä¸­æ–‡æœ¬ä»¥ä¾¿ç¼–è¾‘
            }
        }, 100);
    }
    
    // åˆ é™¤ä¸æŒ‡å®šå¾…åŠäº‹é¡¹å…³è”çš„å®Œæˆäº‹é¡¹
    removeRelatedCompleted(todoId) {
        const index = this.currentDiary.completed.findIndex(c => c.relatedTodoId === todoId);
        if (index >= 0) {
            this.currentDiary.completed.splice(index, 1);
        }
    }
    
    // æ›´æ–°å¾…åŠå…³è”
    updateTodoRelation(id, eventId) {
        const todo = this.currentDiary.todos.find(t => t.id === id);
        if (todo) {
            todo.relatedEventId = eventId;
            this.scheduleAutoSave();
        }
    }
    
    // æ›´æ–°å®Œæˆäº‹é¡¹å…³è”
    updateCompletedRelation(id, todoId) {
        const completed = this.currentDiary.completed.find(c => c.id === id);
        if (completed) {
            completed.relatedTodoId = todoId;
            this.scheduleAutoSave();
        }
    }
    
    // æ–‡æœ¬å±•å¼€/æŠ˜å åŠŸèƒ½
    toggleTextExpansion(button) {
        const listItem = button.closest('.list-item');
        const input = listItem.querySelector('input[type="text"]');
        
        if (listItem.classList.contains('text-expanded')) {
            // æŠ˜å æ–‡æœ¬
            listItem.classList.remove('text-expanded');
            button.textContent = '...';
            button.title = 'å±•å¼€æ–‡æœ¬';
        } else {
            // å±•å¼€æ–‡æœ¬
            listItem.classList.add('text-expanded');
            button.textContent = 'æ”¶èµ·';
            button.title = 'æ”¶èµ·æ–‡æœ¬';
        }
    }
    
    // æ›´æ–°æ–‡æœ¬å±•å¼€æŒ‰é’®
    updateTextExpansionButton(container, text) {
        const isLongText = text.length > 50;
        const expandBtn = container.querySelector('.text-expand-btn');
        const input = container.querySelector('input[type="text"]');
        
        if (isLongText && !expandBtn) {
            // æ·»åŠ å±•å¼€æŒ‰é’®
            const newBtn = document.createElement('button');
            newBtn.className = 'text-expand-btn';
            newBtn.textContent = '...';
            newBtn.title = 'å±•å¼€æ–‡æœ¬';
            newBtn.onclick = () => this.toggleTextExpansion(newBtn);
            
            input.insertAdjacentElement('afterend', newBtn);
            input.title = text;
            this.addTextTooltip(input);
        } else if (!isLongText && expandBtn) {
            // ç§»é™¤å±•å¼€æŒ‰é’®
            expandBtn.remove();
            input.title = '';
            container.classList.remove('text-expanded');
            this.removeTextTooltip(input);
        } else if (isLongText && expandBtn) {
            // æ›´æ–°æç¤º
            input.title = text;
        }
    }
    
    // æ·»åŠ æ–‡æœ¬æç¤º
    addTextTooltip(input) {
        let tooltip = null;
        
        input.addEventListener('mouseenter', (e) => {
            if (input.value.length <= 50) return;
            
            // ç§»é™¤ç°æœ‰æç¤º
            this.removeTextTooltip(input);
            
            tooltip = document.createElement('div');
            tooltip.className = 'text-tooltip';
            tooltip.textContent = input.value;
            
            // å®šä½æç¤º
            const rect = input.getBoundingClientRect();
            tooltip.style.left = rect.left + rect.width / 2 + 'px';
            tooltip.style.top = rect.top - 10 + 'px';
            
            document.body.appendChild(tooltip);
            
            // å±•ç¤ºæç¤º
            setTimeout(() => {
                if (tooltip) {
                    tooltip.classList.add('visible');
                }
            }, 100);
        });
        
        input.addEventListener('mouseleave', () => {
            this.removeTextTooltip(input);
        });
    }
    
    // ç§»é™¤æ–‡æœ¬æç¤º
    removeTextTooltip(input) {
        const existingTooltips = document.querySelectorAll('.text-tooltip');
        existingTooltips.forEach(tooltip => tooltip.remove());
    }
    
    // åˆ é™¤äº‹ä»¶ï¼ˆå–æ¶ˆå…³è”æˆ–å®Œå…¨åˆ é™¤ï¼‰
    removeEvent(id, type) {
        if (type === 'majorEvent') {
            // å¯¹äºå¤§äº‹ä»¶ï¼Œå…ˆå–æ¶ˆä¸å½“å‰æ—¥æœŸçš„å…³è”
            const success = diaryManager.dissociateEventFromDate(id, this.currentDate);
            
            if (success) {
                // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–æ—¥æœŸå…³è”
                const associatedDates = diaryManager.getEventAssociatedDates(id);
                
                if (associatedDates.length === 0) {
                    // å¦‚æœæ²¡æœ‰å…¶ä»–å…³è”ï¼Œæç¤ºç”¨æˆ·æ˜¯å¦å®Œå…¨åˆ é™¤
                    ConfirmUtils.confirm(
                        'å®Œå…¨åˆ é™¤äº‹ä»¶',
                        'è¯¥å¤§äº‹ä»¶å·²ä¸æ‰€æœ‰æ—¥æœŸå–æ¶ˆå…³è”ï¼Œæ˜¯å¦å®Œå…¨åˆ é™¤æ­¤äº‹ä»¶ï¼Ÿ',
                        () => {
                            diaryManager.deleteGlobalEvent(id);
                            MessageUtils.showSuccess('å¤§äº‹ä»¶å·²å®Œå…¨åˆ é™¤');
                        },
                        () => {
                            MessageUtils.showInfo('äº‹ä»¶å·²å–æ¶ˆå…³è”ï¼Œä½†ä¿ç•™åœ¨ç³»ç»Ÿä¸­');
                        }
                    );
                } else {
                    MessageUtils.showSuccess(`å·²å–æ¶ˆä¸å½“å‰æ—¥æœŸçš„å…³è”ï¼Œè¯¥äº‹ä»¶è¿˜åœ¨ ${associatedDates.length} ä¸ªæ—¥æœŸä¸­å…³è”`);
                }
                
                this.renderMajorEvents();
                this.scheduleAutoSave();
            }
        }
    }
    
    // åˆ é™¤å¾…åŠ
    removeTodo(id) {
        const index = this.currentDiary.todos.findIndex(t => t.id === id);
        if (index >= 0) {
            this.currentDiary.todos.splice(index, 1);
            this.renderTodos();
            this.scheduleAutoSave();
        }
    }
    
    // åˆ é™¤å®Œæˆäº‹é¡¹
    removeCompleted(id) {
        const index = this.currentDiary.completed.findIndex(c => c.id === id);
        if (index >= 0) {
            this.currentDiary.completed.splice(index, 1);
            this.renderCompleted();
            this.scheduleAutoSave();
        }
    }
    
    // è®¡åˆ’è‡ªåŠ¨ä¿å­˜
    scheduleAutoSave() {
        if (this.autoSaveTimer) {
            clearTimeout(this.autoSaveTimer);
        }
        
        this.autoSaveTimer = setTimeout(() => {
            this.saveDiary();
        }, this.autoSaveDelay);
    }
    
    // ä¿å­˜æ—¥è®°
    saveDiary() {
        if (!this.currentDiary) return;
        
        // æ›´æ–°æ„Ÿæ‚Ÿå†…å®¹
        this.currentDiary.reflection = this.elements.reflectionText.value;
        
        // ä¿å­˜åˆ°å­˜å‚¨
        const success = diaryManager.saveDiary(this.currentDate, this.currentDiary);
        
        if (success) {
            console.log('æ—¥è®°å·²è‡ªåŠ¨ä¿å­˜');
            // æ›´æ–°çƒ­åŠ›å›¾
            this.updateHeatmap();
        } else {
            MessageUtils.showError('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥å­˜å‚¨ç©ºé—´');
        }
    }
    
    // å¯¼å‡ºå½“å‰æ—¥è®°
    exportCurrentDiary() {
        const diary = this.currentDiary;
        const date = this.currentDate;
        const chineseDate = DateUtils.getChineseDate(date);
        
        let content = `# ${chineseDate} æ—¥è®°\n\n`;
        
        // ä»Šæ—¥å¤§äº‹
        content += `## ä»Šæ—¥å¤§äº‹\n`;
        if (diary.majorEvents.length > 0) {
            diary.majorEvents.forEach((event, index) => {
                content += `${index + 1}. ${event.text}\n`;
            });
        } else {
            content += `æš‚æ— è®°å½•\n`;
        }
        content += `\n`;
        
        // ä»Šæ—¥å¾…åŠ
        content += `## ä»Šæ—¥å¾…åŠ\n`;
        if (diary.todos.length > 0) {
            diary.todos.forEach(todo => {
                const status = todo.completed ? 'âœ“' : 'â—‹';
                content += `${status} ${todo.text}\n`;
            });
        } else {
            content += `æš‚æ— è®°å½•\n`;
        }
        content += `\n`;
        
        // å®Œæˆäº‹é¡¹
        content += `## å®Œæˆäº‹é¡¹\n`;
        if (diary.completed.length > 0) {
            diary.completed.forEach((completed, index) => {
                content += `${index + 1}. ${completed.text}\n`;
            });
        } else {
            content += `æš‚æ— è®°å½•\n`;
        }
        content += `\n`;
        
        // ä»Šæ—¥æ„Ÿæ‚Ÿ
        content += `## ä»Šæ—¥æ„Ÿæ‚Ÿ\n`;
        content += diary.reflection || 'æš‚æ— è®°å½•';
        content += `\n\n---\nå¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString()}`;
        
        // å¯¼å‡ºæ–‡ä»¶
        const filename = `æ—¥è®°_${date}.txt`;
        ExportUtils.exportAsText(content, filename);
        
        MessageUtils.showSuccess('æ—¥è®°å¯¼å‡ºæˆåŠŸ');
    }
    
    // æ˜¾ç¤ºå¯¼å‡ºæ¨¡æ€æ¡†
    showExportModal() {
        const modal = document.getElementById('diary-export-modal');
        const startDate = document.getElementById('export-start-date');
        const endDate = document.getElementById('export-end-date');
        
        // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºå½“å¤©
        startDate.value = this.currentDate;
        endDate.value = this.currentDate;
        
        modal.style.display = 'block';
        
        // ç»‘å®šäº‹ä»¶
        this.bindExportModalEvents(modal);
    }
    
    // æ˜¾ç¤ºæ¸…ç©ºæ¨¡æ€æ¡†
    showClearModal() {
        const modal = document.getElementById('diary-clear-modal');
        const startDate = document.getElementById('clear-start-date');
        const endDate = document.getElementById('clear-end-date');
        
        // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºå½“å¤©
        startDate.value = this.currentDate;
        endDate.value = this.currentDate;
        
        modal.style.display = 'block';
        
        // ç»‘å®šäº‹ä»¶
        this.bindClearModalEvents(modal);
    }
    
    // ç»‘å®šå¯¼å‡ºæ¨¡æ€æ¡†äº‹ä»¶
    bindExportModalEvents(modal) {
        // å…³é—­æŒ‰é’®
        const closeBtn = modal.querySelector('.close');
        closeBtn.onclick = () => {
            modal.style.display = 'none';
        };
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.onclick = (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        };
        
        // å¯¼å‡ºå½“å¤©
        document.getElementById('export-current-day').onclick = () => {
            this.exportCurrentDiary();
            modal.style.display = 'none';
        };
        
        // å¯¼å‡ºæ‰€æœ‰æ—¥è®°
        document.getElementById('export-all-diaries').onclick = () => {
            this.exportAllDiaries();
            modal.style.display = 'none';
        };
        
        // å¯¼å‡ºæŒ‡å®šèŒƒå›´
        document.getElementById('export-date-range').onclick = () => {
            const startDate = document.getElementById('export-start-date').value;
            const endDate = document.getElementById('export-end-date').value;
            
            if (!startDate || !endDate) {
                MessageUtils.showError('è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´');
                return;
            }
            
            if (startDate > endDate) {
                MessageUtils.showError('å¼€å§‹æ—¥æœŸä¸èƒ½å¤§äºç»“æŸæ—¥æœŸ');
                return;
            }
            
            this.exportDateRange(startDate, endDate);
            modal.style.display = 'none';
        };
    }
    
    // ç»‘å®šæ¸…ç©ºæ¨¡æ€æ¡†äº‹ä»¶
    bindClearModalEvents(modal) {
        // å…³é—­æŒ‰é’®
        const closeBtn = modal.querySelector('.close');
        closeBtn.onclick = () => {
            modal.style.display = 'none';
        };
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.onclick = (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        };
        
        // æ¸…ç©ºå½“å¤©
        document.getElementById('clear-current-day').onclick = () => {
            this.clearCurrentDiary();
            modal.style.display = 'none';
        };
        
        // æ¸…ç©ºæ‰€æœ‰æ—¥è®°
        document.getElementById('clear-all-diaries').onclick = () => {
            this.clearAllDiaries();
            modal.style.display = 'none';
        };
        
        // æ¸…ç©ºæŒ‡å®šèŒƒå›´
        document.getElementById('clear-date-range').onclick = () => {
            const startDate = document.getElementById('clear-start-date').value;
            const endDate = document.getElementById('clear-end-date').value;
            
            if (!startDate || !endDate) {
                MessageUtils.showError('è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´');
                return;
            }
            
            if (startDate > endDate) {
                MessageUtils.showError('å¼€å§‹æ—¥æœŸä¸èƒ½å¤§äºç»“æŸæ—¥æœŸ');
                return;
            }
            
            this.clearDateRange(startDate, endDate);
            modal.style.display = 'none';
        };
    }
    
    // å¯¼å‡ºæ‰€æœ‰æ—¥è®°
    exportAllDiaries() {
        const allDates = diaryManager.getAllDiaryDates();
        
        if (allDates.length === 0) {
            MessageUtils.showInfo('æ²¡æœ‰æ—¥è®°æ•°æ®å¯å¯¼å‡º');
            return;
        }
        
        let content = '# æ‰€æœ‰æ—¥è®°\n\n';
        
        allDates.forEach(date => {
            const diary = diaryManager.getDiary(date);
            const chineseDate = DateUtils.getChineseDate(date);
            
            content += `## ${chineseDate}\n\n`;
            content += this.formatDiaryContent(diary);
            content += '\n---\n\n';
        });
        
        content += `å¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString()}`;
        
        const filename = `æ‰€æœ‰æ—¥è®°_${DateUtils.getToday()}.txt`;
        ExportUtils.exportAsText(content, filename);
        
        MessageUtils.showSuccess(`å·²å¯¼å‡º ${allDates.length} å¤©çš„æ—¥è®°`);
    }
    
    // å¯¼å‡ºæŒ‡å®šèŒƒå›´çš„æ—¥è®°
    exportDateRange(startDate, endDate) {
        const dates = this.getDateRange(startDate, endDate);
        
        if (dates.length === 0) {
            MessageUtils.showInfo('æŒ‡å®šèŒƒå›´å†…æ²¡æœ‰æ—¥è®°æ•°æ®');
            return;
        }
        
        let content = `# æ—¥è®°å¯¼å‡º (${startDate} è‡³ ${endDate})\n\n`;
        
        dates.forEach(date => {
            const diary = diaryManager.getDiary(date);
            const chineseDate = DateUtils.getChineseDate(date);
            
            content += `## ${chineseDate}\n\n`;
            content += this.formatDiaryContent(diary);
            content += '\n---\n\n';
        });
        
        content += `å¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString()}`;
        
        const filename = `æ—¥è®°_${startDate}_è‡³_${endDate}.txt`;
        ExportUtils.exportAsText(content, filename);
        
        MessageUtils.showSuccess(`å·²å¯¼å‡º ${dates.length} å¤©çš„æ—¥è®°`);
    }
    
    // æ ¼å¼åŒ–æ—¥è®°å†…å®¹
    formatDiaryContent(diary) {
        let content = '';
        
        // ä»Šæ—¥å¤§äº‹
        content += `### ä»Šæ—¥å¤§äº‹\n`;
        if (diary.majorEvents.length > 0) {
            diary.majorEvents.forEach((event, index) => {
                content += `${index + 1}. ${event.text}\n`;
            });
        } else {
            content += `æš‚æ— è®°å½•\n`;
        }
        content += `\n`;
        
        // ä»Šæ—¥å¾…åŠ
        content += `### ä»Šæ—¥å¾…åŠ\n`;
        if (diary.todos.length > 0) {
            diary.todos.forEach(todo => {
                const status = todo.completed ? 'âœ“' : 'â—‹';
                content += `${status} ${todo.text}\n`;
            });
        } else {
            content += `æš‚æ— è®°å½•\n`;
        }
        content += `\n`;
        
        // å®Œæˆäº‹é¡¹
        content += `### å®Œæˆäº‹é¡¹\n`;
        if (diary.completed.length > 0) {
            diary.completed.forEach((completed, index) => {
                content += `${index + 1}. ${completed.text}\n`;
            });
        } else {
            content += `æš‚æ— è®°å½•\n`;
        }
        content += `\n`;
        
        // ä»Šæ—¥æ„Ÿæ‚Ÿ
        content += `### ä»Šæ—¥æ„Ÿæ‚Ÿ\n`;
        content += diary.reflection || 'æš‚æ— è®°å½•';
        content += `\n`;
        
        return content;
    }
    
    // æ¸…ç©ºå½“å¤©æ—¥è®°
    clearCurrentDiary() {
        ConfirmUtils.confirm(
            'æ¸…ç©ºå½“å¤©æ—¥è®°',
            `ç¡®å®šè¦æ¸…ç©º ${DateUtils.getChineseDate(this.currentDate)} çš„æ—¥è®°å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`,
            () => {
                const success = diaryManager.deleteDiary(this.currentDate);
                if (success) {
                    this.currentDiary = diaryManager.createEmptyDiary();
                    this.renderDiary();
                    MessageUtils.showSuccess('å½“å¤©æ—¥è®°å·²æ¸…ç©º');
                } else {
                    MessageUtils.showError('æ¸…ç©ºå¤±è´¥');
                }
            }
        );
    }
    
    // æ¸…ç©ºæ‰€æœ‰æ—¥è®°
    clearAllDiaries() {
        const allDates = diaryManager.getAllDiaryDates();
        
        if (allDates.length === 0) {
            MessageUtils.showInfo('æ²¡æœ‰æ—¥è®°æ•°æ®å¯æ¸…ç©º');
            return;
        }
        
        ConfirmUtils.confirm(
            'æ¸…ç©ºæ‰€æœ‰æ—¥è®°',
            `ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ ${allDates.length} å¤©çš„æ—¥è®°å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`,
            () => {
                let successCount = 0;
                allDates.forEach(date => {
                    if (diaryManager.deleteDiary(date)) {
                        successCount++;
                    }
                });
                
                // æ›´æ–°å½“å‰æ˜¾ç¤º
                if (allDates.includes(this.currentDate)) {
                    this.currentDiary = diaryManager.createEmptyDiary();
                    this.renderDiary();
                }
                
                MessageUtils.showSuccess(`å·²æ¸…ç©º ${successCount} å¤©çš„æ—¥è®°`);
            }
        );
    }
    
    // æ¸…ç©ºæŒ‡å®šèŒƒå›´çš„æ—¥è®°
    clearDateRange(startDate, endDate) {
        const dates = this.getDateRange(startDate, endDate);
        
        if (dates.length === 0) {
            MessageUtils.showInfo('æŒ‡å®šèŒƒå›´å†…æ²¡æœ‰æ—¥è®°æ•°æ®');
            return;
        }
        
        ConfirmUtils.confirm(
            'æ¸…ç©ºæŒ‡å®šèŒƒå›´æ—¥è®°',
            `ç¡®å®šè¦æ¸…ç©º ${startDate} è‡³ ${endDate} èŒƒå›´å†…çš„ ${dates.length} å¤©æ—¥è®°å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`,
            () => {
                let successCount = 0;
                dates.forEach(date => {
                    if (diaryManager.deleteDiary(date)) {
                        successCount++;
                    }
                });
                
                // æ›´æ–°å½“å‰æ˜¾ç¤º
                if (dates.includes(this.currentDate)) {
                    this.currentDiary = diaryManager.createEmptyDiary();
                    this.renderDiary();
                }
                
                MessageUtils.showSuccess(`å·²æ¸…ç©º ${successCount} å¤©çš„æ—¥è®°`);
            }
        );
    }
    
    // è·å–æ—¥æœŸèŒƒå›´
    getDateRange(startDate, endDate) {
        const dates = [];
        const start = DateUtils.parseDate(startDate);
        const end = DateUtils.parseDate(endDate);
        const allDates = diaryManager.getAllDiaryDates();
        
        for (let date = start; date <= end; date.setDate(date.getDate() + 1)) {
            const dateStr = DateUtils.formatDate(date);
            if (allDates.includes(dateStr)) {
                dates.push(dateStr);
            }
        }
        
        return dates;
    }
    
    // æ˜¾ç¤ºå¯¼å‡ºæ¨¡æ€æ¡†
    showExportModal() {
        const modal = document.getElementById('diary-export-modal');
        const startDate = document.getElementById('export-start-date');
        const endDate = document.getElementById('export-end-date');
        
        // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºå½“å¤©
        startDate.value = this.currentDate;
        endDate.value = this.currentDate;
        
        modal.style.display = 'block';
        this.bindExportModalEvents(modal);
    }
    
    // æ˜¾ç¤ºæ¸…ç©ºæ¨¡æ€æ¡†
    showClearModal() {
        const modal = document.getElementById('diary-clear-modal');
        const startDate = document.getElementById('clear-start-date');
        const endDate = document.getElementById('clear-end-date');
        
        // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºå½“å¤©
        startDate.value = this.currentDate;
        endDate.value = this.currentDate;
        
        modal.style.display = 'block';
        this.bindClearModalEvents(modal);
    }
    
    // ç»‘å®šå¯¼å‡ºæ¨¡æ€æ¡†äº‹ä»¶
    bindExportModalEvents(modal) {
        const closeBtn = modal.querySelector('.close');
        const exportCurrentDay = document.getElementById('export-current-day');
        const exportAllDiaries = document.getElementById('export-all-diaries');
        const exportDateRange = document.getElementById('export-date-range');
        
        const closeModal = () => {
            modal.style.display = 'none';
        };
        
        // ç»‘å®šå…³é—­äº‹ä»¶
        const handleCloseClick = (e) => {
            e.stopPropagation();
            closeModal();
        };
        
        const handleModalClick = (e) => {
            if (e.target === modal) {
                closeModal();
            }
        };
        
        closeBtn.onclick = handleCloseClick;
        modal.onclick = handleModalClick;
        
        // ç»‘å®šå¯¼å‡ºäº‹ä»¶
        exportCurrentDay.onclick = () => {
            this.exportCurrentDiary();
            closeModal();
        };
        
        exportAllDiaries.onclick = () => {
            this.exportAllDiaries();
            closeModal();
        };
        
        exportDateRange.onclick = () => {
            const startDate = document.getElementById('export-start-date').value;
            const endDate = document.getElementById('export-end-date').value;
            
            if (!startDate || !endDate) {
                MessageUtils.showError('è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ');
                return;
            }
            
            if (startDate > endDate) {
                MessageUtils.showError('å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ');
                return;
            }
            
            this.exportDateRange(startDate, endDate);
            closeModal();
        };
    }
    
    // ç»‘å®šæ¸…ç©ºæ¨¡æ€æ¡†äº‹ä»¶
    bindClearModalEvents(modal) {
        const closeBtn = modal.querySelector('.close');
        const clearCurrentDay = document.getElementById('clear-current-day');
        const clearAllDiaries = document.getElementById('clear-all-diaries');
        const clearDateRange = document.getElementById('clear-date-range');
        
        const closeModal = () => {
            modal.style.display = 'none';
        };
        
        // ç»‘å®šå…³é—­äº‹ä»¶
        const handleCloseClick = (e) => {
            e.stopPropagation();
            closeModal();
        };
        
        const handleModalClick = (e) => {
            if (e.target === modal) {
                closeModal();
            }
        };
        
        closeBtn.onclick = handleCloseClick;
        modal.onclick = handleModalClick;
        
        // ç»‘å®šæ¸…ç©ºäº‹ä»¶
        clearCurrentDay.onclick = () => {
            this.clearCurrentDiary();
            closeModal();
        };
        
        clearAllDiaries.onclick = () => {
            this.clearAllDiaries();
            closeModal();
        };
        
        clearDateRange.onclick = () => {
            const startDate = document.getElementById('clear-start-date').value;
            const endDate = document.getElementById('clear-end-date').value;
            
            if (!startDate || !endDate) {
                MessageUtils.showError('è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ');
                return;
            }
            
            if (startDate > endDate) {
                MessageUtils.showError('å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ');
                return;
            }
            
            this.clearDateRange(startDate, endDate);
            closeModal();
        };
    }
    
    // åˆå§‹åŒ–çƒ­åŠ›å›¾
    initializeHeatmap() {
        this.heatmapExpanded = false;
        
        // ç¡®ä¿åœ¨DOMå®Œå…¨åŠ è½½åå†ç»‘å®šäº‹ä»¶
        const bindEvents = () => {
            this.bindHeatmapEvents();
        };
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', bindEvents);
        } else {
            // DOMå·²ç»åŠ è½½å®Œæ¯•
            setTimeout(bindEvents, 0);
        }
        
        // åˆå§‹åŒ–æ—¶è®¾ç½®ä¸ºéšè—çŠ¶æ€
        const container = document.getElementById('diary-heatmap');
        if (container) {
            container.classList.add('hidden');
        }
        
        // æ·»åŠ çª—å£å¤§å°æ”¹å˜ç›‘å¬å™¨
        let resizeTimer;
        window.addEventListener('resize', () => {
            // é˜²æŠ–å¤„ç†ï¼Œé¿å…é¢‘ç¹é‡æ–°ç”Ÿæˆ
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                if (this.heatmapExpanded) {
                    this.generateHeatmap();
                }
            }, 300);
        });
    }
    
    // ç»‘å®šçƒ­åŠ›å›¾äº‹ä»¶
    bindHeatmapEvents() {
        const toggleBtn = document.getElementById('toggle-heatmap');
        
        if (toggleBtn) {
            // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶
            toggleBtn.onclick = null;
            
            // ä½¿ç”¨æœ€ç®€å•ç›´æ¥çš„onclickç»‘å®š
            toggleBtn.onclick = () => {
                this.toggleHeatmap();
            };
            
        } else {
            console.error('æœªæ‰¾åˆ°çƒ­åŠ›å›¾åˆ‡æ¢æŒ‰é’®ï¼');
        }
    }
    
    // åˆ‡æ¢çƒ­åŠ›å›¾å±•å¼€/æŠ˜å çŠ¶æ€
    toggleHeatmap() {
        const container = document.getElementById('diary-heatmap');
        const toggleBtn = document.getElementById('toggle-heatmap');
        const arrow = toggleBtn.querySelector('.toggle-arrow');
        const text = toggleBtn.querySelector('.toggle-text');
        
        if (!container || !toggleBtn || !arrow || !text) {
            console.error('çƒ­åŠ›å›¾å…ƒç´ æœªæ‰¾åˆ°');
            return;
        }
        
        // åˆ‡æ¢çŠ¶æ€
        this.heatmapExpanded = !this.heatmapExpanded;
        
        if (this.heatmapExpanded) {
            // å±•å¼€çƒ­åŠ›å›¾
            container.classList.remove('hidden');
            arrow.textContent = 'â–¼';  // å‘ä¸‹ç®­å¤´
            text.textContent = 'æŠ˜å çƒ­åŠ›å›¾';
            toggleBtn.title = 'æŠ˜å æ—¥è®°çƒ­åŠ›å›¾';
            this.generateHeatmap();
        } else {
            // æŠ˜å çƒ­åŠ›å›¾
            container.classList.add('hidden');
            arrow.textContent = 'â—€';  // å‘å·¦ç®­å¤´
            text.textContent = 'å±•å¼€çƒ­åŠ›å›¾';
            toggleBtn.title = 'å±•å¼€æ—¥è®°çƒ­åŠ›å›¾';
        }
    }
    
    // ç”Ÿæˆçƒ­åŠ›å›¾
    generateHeatmap() {
        if (!this.heatmapExpanded) return;
        
        const grid = document.getElementById('heatmap-grid');
        const monthsContainer = document.getElementById('heatmap-months');
        const today = new Date();
        const endDate = new Date(today);
        const startDate = new Date(today);
        
        // æ ¹æ®å±å¹•å¤§å°å†³å®šæ˜¾ç¤ºçš„å¤©æ•°å’Œå‘¨æ•°
        const isMobile = window.innerWidth <= 768;
        let weeksToShow, daysToShow;
        
        if (isMobile) {
            // æ‰‹æœºç«¯ï¼šæ˜¾ç¤ºæ›´å°‘çš„å‘¨æ•°ç¡®ä¿ä¸€è¡Œå®Œå…¨å±•ç¤º
            // è®¡ç®—æ‰‹æœºå±å¹•èƒ½å®¹çº³çš„æœ€å¤§å‘¨æ•°
            const screenWidth = window.innerWidth;
            const cellWidth = 10; // æ ¼å­å®½åº¦ï¼ˆåŒ¹é…CSSï¼‰
            const gap = 1; // é—´éš™ï¼ˆåŒ¹é…CSSï¼‰
            const weekdayWidth = 14; // æ˜ŸæœŸæ ‡ç­¾å®½åº¦ï¼ˆåŒ¹é…CSSï¼‰
            const padding = 48; // å·¦å³è¾¹è·å’Œå…¶ä»–å…ƒç´ çš„ç©ºé—´
            
            // è®¡ç®—æœ€å¤§å¯å®¹çº³çš„å‘¨æ•°
            const availableWidth = screenWidth - weekdayWidth - padding;
            const weekWidth = cellWidth + gap;
            const maxWeeks = Math.floor(availableWidth / weekWidth);
            
            // ç¡®ä¿ä¸è¶…è¿‡18å‘¨ï¼ˆçº¦4.5ä¸ªæœˆï¼‰ï¼Œå¹¶ä¸”ä¸å°‘äº10å‘¨ï¼ˆçº¦2.5ä¸ªæœˆï¼‰
            weeksToShow = Math.min(Math.max(maxWeeks, 10), 18);
            daysToShow = weeksToShow * 7 - 1;
        } else {
            // ç”µè„‘ç«¯ï¼šæ˜¾ç¤ºæ›´å¤šå‘¨æ•°ä½†æ ¼å­æ›´å¤§
            weeksToShow = 39; // æ˜¾ç¤º39å‘¨ï¼ˆçº¦9ä¸ªæœˆï¼‰
            daysToShow = weeksToShow * 7 - 1;
        }
        
        startDate.setDate(startDate.getDate() - daysToShow);
        
        // æ¸…ç©ºç°æœ‰å†…å®¹
        grid.innerHTML = '';
        monthsContainer.innerHTML = '';
        
        // è·å–æ‰€æœ‰æ—¥è®°æ•°æ®
        const allDiaries = diaryManager.getAllDiaries();
        
        // ç”Ÿæˆæœˆä»½æ ‡ç­¾
        this.generateMonthLabels(monthsContainer, startDate, endDate, weeksToShow);
        
        // ç”Ÿæˆæ—¥æœŸç½‘æ ¼ï¼ˆæŒ‰åˆ—æ’åˆ—ï¼Œæ¯åˆ—7å¤©ï¼‰
        const dateGrid = this.generateDateGrid(startDate, endDate, weeksToShow);
        
        // æ›´æ–°CSSç½‘æ ¼åˆ—æ•°
        grid.style.gridTemplateColumns = `repeat(${weeksToShow}, 1fr)`;
        
        // å¡«å……ç½‘æ ¼
        dateGrid.forEach(dateStr => {
            if (dateStr) {
                const dayElement = this.createHeatmapDay(dateStr, allDiaries[dateStr]);
                grid.appendChild(dayElement);
            } else {
                // ç©ºæ ¼å­ç”¨äºå¯¹é½
                const emptyElement = document.createElement('div');
                emptyElement.className = 'heatmap-cell empty';
                emptyElement.style.visibility = 'hidden';
                grid.appendChild(emptyElement);
            }
        });
        
        // åŒæ—¶æ›´æ–°æœˆä»½æ ‡ç­¾çš„ç½‘æ ¼åˆ—æ•°
        monthsContainer.style.gridTemplateColumns = `repeat(${weeksToShow}, 1fr)`;
    }
    
    // ç”Ÿæˆæœˆä»½æ ‡ç­¾
    generateMonthLabels(container, startDate, endDate, weeksToShow) {
        const months = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', 
                       '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
        
        // åˆ›å»ºä¸€ä¸ªåŒ…å«æŒ‡å®šå‘¨æ•°çš„æ•°ç»„
        const weekLabels = new Array(weeksToShow).fill('');
        
        // è®¡ç®—èµ·å§‹æ—¥æœŸæ˜¯æ˜ŸæœŸå‡ ï¼ˆ0=å‘¨æ—¥ï¼Œ1=å‘¨ä¸€...ï¼‰
        let currentDate = new Date(startDate);
        const firstDayOfWeek = (currentDate.getDay() + 6) % 7; // è½¬æ¢ä¸ºå‘¨ä¸€=0çš„æ ¼å¼
        
        // è°ƒæ•´åˆ°ç¬¬ä¸€ä¸ªå®Œæ•´å‘¨çš„å¼€å§‹
        currentDate.setDate(currentDate.getDate() - firstDayOfWeek);
        
        let weekIndex = 0;
        let lastMonth = -1;
        
        // éå†æ¯ä¸€å‘¨
        while (weekIndex < weeksToShow && currentDate <= endDate) {
            const currentMonth = currentDate.getMonth();
            
            // å¦‚æœæœˆä»½å˜åŒ–ä¸”ä¸æ˜¯ç¬¬ä¸€å‘¨ï¼Œæ·»åŠ æœˆä»½æ ‡ç­¾
            if (currentMonth !== lastMonth && weekIndex > 0) {
                weekLabels[weekIndex] = months[currentMonth];
                lastMonth = currentMonth;
            } else if (weekIndex === 0) {
                // ç¬¬ä¸€å‘¨æ€»æ˜¯æ˜¾ç¤ºæœˆä»½
                weekLabels[weekIndex] = months[currentMonth];
                lastMonth = currentMonth;
            }
            
            // ç§»åŠ¨åˆ°ä¸‹ä¸€å‘¨
            currentDate.setDate(currentDate.getDate() + 7);
            weekIndex++;
        }
        
        // åˆ›å»ºæœˆä»½æ ‡ç­¾å…ƒç´ 
        weekLabels.forEach(label => {
            const monthElement = document.createElement('div');
            monthElement.className = 'month-label';
            monthElement.textContent = label;
            container.appendChild(monthElement);
        });
    }
    
    // ç”Ÿæˆæ—¥æœŸç½‘æ ¼æ•°ç»„ï¼ˆæŒ‰åˆ—æ’åˆ—ï¼ŒGitHubé£æ ¼ï¼‰
    generateDateGrid(startDate, endDate, weeksToShow) {
        const grid = [];
        
        // è®¡ç®—èµ·å§‹æ—¥æœŸæ˜¯æ˜ŸæœŸå‡ ï¼ˆ0=å‘¨ä¸€ï¼Œ1=å‘¨äºŒ...6=å‘¨æ—¥ï¼‰
        let currentDate = new Date(startDate);
        const firstDayOfWeek = (currentDate.getDay() + 6) % 7;
        
        // è°ƒæ•´åˆ°ç¬¬ä¸€ä¸ªå®Œæ•´å‘¨çš„å¼€å§‹ï¼ˆå‘¨ä¸€ï¼‰
        currentDate.setDate(currentDate.getDate() - firstDayOfWeek);
        
        // ç”ŸæˆæŒ‡å®šå‘¨æ•°çš„ç½‘æ ¼ï¼Œæ¯åˆ—7å¤©ï¼ˆçºµå‘æ’åˆ—ï¼‰
        for (let week = 0; week < weeksToShow; week++) {
            for (let day = 0; day < 7; day++) {
                const weekIndex = week;
                const dayIndex = day;
                
                if (currentDate >= startDate && currentDate <= endDate) {
                    // è®¡ç®—åœ¨ç½‘æ ¼ä¸­çš„ä½ç½®ï¼ˆåˆ—ä¼˜å…ˆï¼Œå³çºµå‘æ’åˆ—ï¼‰
                    const gridIndex = weekIndex * 7 + dayIndex;
                    grid[gridIndex] = DateUtils.formatDate(currentDate);
                } else {
                    const gridIndex = weekIndex * 7 + dayIndex;
                    grid[gridIndex] = null; // ç©ºæ ¼å­
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
        }
        
        return grid;
    }
    
    // åˆ›å»ºçƒ­åŠ›å›¾ä¸­çš„å•ä¸ªæ—¥æœŸæ ¼å­
    createHeatmapDay(dateStr, diaryData) {
        const dayElement = document.createElement('div');
        dayElement.className = 'heatmap-cell';
        dayElement.dataset.date = dateStr;
        
        // è®¡ç®—æ´»è·ƒåº¦ç­‰çº§
        const level = this.calculateActivityLevel(diaryData);
        dayElement.dataset.level = level;
        
        // å¦‚æœæ˜¯ä»Šå¤©ï¼Œæ·»åŠ ç‰¹æ®Šæ ·å¼
        if (dateStr === DateUtils.getToday()) {
            dayElement.classList.add('today');
        }
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
        dayElement.onclick = () => {
            this.loadDiary(dateStr);
            // æ»šåŠ¨åˆ°æ—¥æœŸå¯¼èˆªä½ç½®
            document.querySelector('.date-nav').scrollIntoView({ 
                behavior: 'smooth' 
            });
        };
        
        // æ·»åŠ æ‚¬åœæç¤º
        dayElement.onmouseenter = (e) => {
            this.showHeatmapTooltip(e, dateStr, diaryData);
        };
        
        dayElement.onmouseleave = () => {
            this.hideHeatmapTooltip();
        };
        
        return dayElement;
    }
    
    // è®¡ç®—æ´»è·ƒåº¦ç­‰çº§ï¼ˆ0-4ï¼‰
    calculateActivityLevel(diaryData) {
        if (!diaryData) return 0;
        
        let score = 0;
        
        // å¤§äº‹ä»¶è®¡åˆ†
        score += (diaryData.majorEvents || []).length * 2;
        
        // å¾…åŠäº‹é¡¹è®¡åˆ†
        score += (diaryData.todos || []).length * 1;
        
        // å®Œæˆäº‹é¡¹è®¡åˆ†
        score += (diaryData.completed || []).length * 1;
        
        // æ„Ÿæ‚Ÿå†…å®¹è®¡åˆ†
        if (diaryData.reflection && diaryData.reflection.trim().length > 0) {
            score += Math.min(diaryData.reflection.length / 50, 3); // æœ€å¤š3åˆ†
        }
        
        // è½¬æ¢ä¸º0-4ç­‰çº§
        if (score === 0) return 0;
        if (score <= 2) return 1;
        if (score <= 5) return 2;
        if (score <= 10) return 3;
        return 4;
    }
    
    // æ˜¾ç¤ºçƒ­åŠ›å›¾æç¤º
    showHeatmapTooltip(event, dateStr, diaryData) {
        // ç§»é™¤ç°æœ‰æç¤º
        this.hideHeatmapTooltip();
        
        const tooltip = document.createElement('div');
        tooltip.className = 'heatmap-tooltip show';
        tooltip.id = 'heatmap-tooltip';
        
        const chineseDate = DateUtils.getChineseDate(dateStr);
        const level = this.calculateActivityLevel(diaryData);
        const levelText = ['æ— è®°å½•', 'å°‘é‡è®°å½•', 'ä¸­ç­‰è®°å½•', 'ä¸°å¯Œè®°å½•', 'è¯¦ç»†è®°å½•'][level];
        
        let content = `${chineseDate}<br>${levelText}`;
        
        if (diaryData) {
            const stats = [];
            if (diaryData.majorEvents && diaryData.majorEvents.length > 0) {
                stats.push(`${diaryData.majorEvents.length}ä¸ªå¤§äº‹`);
            }
            if (diaryData.todos && diaryData.todos.length > 0) {
                stats.push(`${diaryData.todos.length}ä¸ªå¾…åŠ`);
            }
            if (diaryData.completed && diaryData.completed.length > 0) {
                stats.push(`${diaryData.completed.length}ä¸ªå®Œæˆ`);
            }
            if (diaryData.reflection && diaryData.reflection.trim().length > 0) {
                stats.push('æœ‰æ„Ÿæ‚Ÿ');
            }
            
            if (stats.length > 0) {
                content += `<br>${stats.join('ï¼Œ')}`;
            }
        }
        
        tooltip.innerHTML = content;
        
        // å®šä½æç¤º
        const rect = event.target.getBoundingClientRect();
        tooltip.style.left = rect.left + rect.width / 2 + 'px';
        tooltip.style.top = rect.top - 10 + 'px';
        tooltip.style.transform = 'translateX(-50%) translateY(-100%)';
        
        document.body.appendChild(tooltip);
    }
    
    // éšè—çƒ­åŠ›å›¾æç¤º
    hideHeatmapTooltip() {
        const tooltip = document.getElementById('heatmap-tooltip');
        if (tooltip) {
            tooltip.remove();
        }
    }
    
    // æ›´æ–°çƒ­åŠ›å›¾ï¼ˆå½“ä¿å­˜æ—¥è®°æ—¶è°ƒç”¨ï¼‰
    updateHeatmap() {
        if (this.heatmapExpanded) {
            this.generateHeatmap();
        }
    }
}

// åˆå§‹åŒ–æ—¥è®°æ§åˆ¶å™¨
let diaryController;